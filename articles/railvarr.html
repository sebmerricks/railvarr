<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="railvarr">
<title>railvarr • railvarr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="railvarr">
<meta property="og:description" content="railvarr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">railvarr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/railvarr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/sebmerricks/railvarr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>railvarr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sebmerricks/railvarr/blob/HEAD/vignettes/railvarr.Rmd" class="external-link"><code>vignettes/railvarr.Rmd</code></a></small>
      <div class="d-none name"><code>railvarr.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sebmerricks/railvarr" class="external-link">railvarr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette will guide you through the <code>railvarr</code>
processing pipeline from start to finish. It is assumed that you are
already in possession of Centrix and timetable data.</p>
<p><code>railvarr</code> provides no functionality for reading raw data.
Instead, you should massage your data to match the description of
<code>raw_centrix</code> in <code><a href="../reference/wrangle_centrix.html">wrangle_centrix()</a></code> and of
<code>timetable</code> in <code><a href="../reference/wrangle_timetable.html">wrangle_timetable()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="centrix">Centrix<a class="anchor" aria-label="anchor" href="#centrix"></a>
</h2>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>Railway tracks are separated into distinct blocks, called berths.
These berths are protected by signals. In this example, there is a train
in berth D and the signals are using a <a href="https://safety.networkrail.co.uk/jargon-buster/four-aspect-signal/" class="external-link">4-aspect
system</a>.</p>
<p><img src="img/berth-diagram.png" width="100%"></p>
<p>Each berth is made up of one or more track sections, which are fitted
with <a href="https://www.networkrail.co.uk/stories/track-circuits-explained/" class="external-link">track
circuits</a>. These track circuits detect the presence or absence of
trains, triggering changes in the signalling system.</p>
<p>Centrix data comes from the state transitions caused by train
movements, detected by track circuits.</p>
<p><img src="img/centrix-example.png" width="100%"></p>
<p>Note that there is a small offset between the train entering a berth
and the signal changing to red. There is also an offset between the
train vacating the berth and the signal changing to yellow.</p>
<p>The Centrix observations derived from these events would be as
follows:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 3</span></span></span>
<span><span class="co">#&gt;   asset     dt transition</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> D TR       0 UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> S1 DGE     1 UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> S1 RGE     1 DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> E TR      40 UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> D TR      50 DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> S1 RGE    55 UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> S1 HGE    55 DN to UP</span></span></code></pre>
<p>The track (denoted by a <code>" TR"</code> suffix on the asset ID)
transitions come from the track circuits. Therefore,
<code>"UP to DN"</code> denotes a train entering the track, while
<code>"DN to UP"</code> denotes a train vacating the track.</p>
<p>Signal transitions are different, with <code>"UP to DN"</code>
representing a change FROM a state, while <code>"DN to UP"</code>
represents a change TO a state. Therefore, the second observation says
that signal <code>S1</code> changed off of green (<code>DGE</code>) at
time <code>1</code>. The third observation correspondingly says that
signal <code>S1</code> changed to red (<code>RGE</code>) at time
<code>1</code>. The signal state (which corresponds to its aspect) is
embedded as a suffix to the asset ID.</p>
</div>
<div class="section level3">
<h3 id="processing">Processing<a class="anchor" aria-label="anchor" href="#processing"></a>
</h3>
<p><code>railvarr</code> provides a number of functions to facilitate
the processing of Centrix data. These functions are wrapped by the
function <code><a href="../reference/wrangle_centrix.html">wrangle_centrix()</a></code>. See the specific function
documentation for more details.</p>
<p><code><a href="../reference/wrangle_centrix.html">wrangle_centrix()</a></code> requires raw Centrix data as described
in the previous section, as well as a map of the track sections of
interest. This map specifies which signals, tracks, and berths make up
the section. Since berths can contain more than one track but only one
signal, the map provides a 1-1 mapping from signal to berth, and a
1-many mapping from berth to track.</p>
<p>The map also contains a column named <code>event</code>, which
represents the fact that a train can both enter and vacate a track. This
allows for finer control over the start and end of the track section.
For example, if we wanted to have access to the time at which the train
entered berth E, we would have to include an <code>'enters'</code> event
for berth E in the map.</p>
<p>The map for the previous example of berths C to E would be as
follows:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   signal berth track event  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> S1     D     TD    enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> S1     D     TD    vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> S2     E     TE    enters</span></span></code></pre>
<p>Note that we don’t need to include berth C in the map unless we
wanted access to the time at which the train vacated that berth. To
process the 7 observations derived from the example, this map is
sufficient.</p>
<p>This representation of the network map is limited, as it can only
handle linear sections of track, travelling in a single direction. More
complex track layouts such as junctions are not supported.</p>
<p>With a <code>raw_centrix</code> data frame along with the
<code>asset_map</code>, you can process the data using:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">raw_centrix</span>, <span class="va">asset_map</span><span class="op">)</span></span>
<span><span class="va">raw_centrix</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 110,339 × 3</span></span></span>
<span><span class="co">#&gt;    asset   dt                  transition</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> TA-1 TR 2000-01-01 <span style="color: #949494;">06:13:48</span> UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> S1 HHGE 2000-01-01 <span style="color: #949494;">06:13:49</span> UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> S1 HGE  2000-01-01 <span style="color: #949494;">06:13:49</span> UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> S1 RGE  2000-01-01 <span style="color: #949494;">06:13:49</span> DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> TA-1 TR 2000-01-01 <span style="color: #949494;">06:25:29</span> DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> TA-1 TR 2000-01-01 <span style="color: #949494;">06:25:31</span> UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> TA-1 TR 2000-01-01 <span style="color: #949494;">06:25:43</span> DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> S1 HHGE 2000-01-01 <span style="color: #949494;">06:25:48</span> DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> S1 HGE  2000-01-01 <span style="color: #949494;">06:25:48</span> DN to UP  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> S1 RGE  2000-01-01 <span style="color: #949494;">06:25:48</span> UP to DN  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 110,329 more rows</span></span></span>
<span><span class="va">asset_map</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 17 × 4</span></span></span>
<span><span class="co">#&gt;    signal berth track event  </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> S1     A     TA-1  enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> S1     A     TA-2  vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> S2     B     TB-1  enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> S2     B     TB-2  vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> S3     C     TC-1  enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> S3     C     TC-2  vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> S4     D     TD    enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> S4     D     TD    vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> S5     E     TE    enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> S5     E     TE    vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> S6     F     TF-1  enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> S6     F     TF-2  vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> S7     G     TG-1  enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> S7     G     TG-2  vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> S8     H     TH    enters </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> S8     H     TH    vacates</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> S9     I     TI    enters</span></span>
<span><span class="fu">railvarr</span><span class="fu">::</span><span class="fu"><a href="../reference/wrangle_centrix.html">wrangle_centrix</a></span><span class="op">(</span><span class="va">raw_centrix</span>, <span class="va">asset_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6,952 × 15</span></span></span>
<span><span class="co">#&gt;    signal berth train_id aspect t_enters            t_red_on           </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> S1     A            1 G      2000-01-01 <span style="color: #949494;">13:07:11</span> 2000-01-01 <span style="color: #949494;">13:07:12</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> S2     B            1 G      2000-01-01 <span style="color: #949494;">13:09:18</span> 2000-01-01 <span style="color: #949494;">13:09:19</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> S3     C            1 G      2000-01-01 <span style="color: #949494;">13:09:58</span> 2000-01-01 <span style="color: #949494;">13:09:59</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> S4     D            1 G      2000-01-01 <span style="color: #949494;">13:10:41</span> 2000-01-01 <span style="color: #949494;">13:10:42</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> S5     E            1 G      2000-01-01 <span style="color: #949494;">13:12:39</span> 2000-01-01 <span style="color: #949494;">13:12:39</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> S6     F            1 G      2000-01-01 <span style="color: #949494;">13:13:18</span> 2000-01-01 <span style="color: #949494;">13:13:19</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> S7     G            1 G      2000-01-01 <span style="color: #949494;">13:15:35</span> 2000-01-01 <span style="color: #949494;">13:15:35</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> S8     H            1 G      2000-01-01 <span style="color: #949494;">13:16:19</span> 2000-01-01 <span style="color: #949494;">13:16:20</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> S1     A            2 G      2000-01-01 <span style="color: #949494;">13:11:58</span> 2000-01-01 <span style="color: #949494;">13:11:59</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> S2     B            2 YY     2000-01-01 <span style="color: #949494;">13:12:43</span> 2000-01-01 <span style="color: #949494;">13:12:43</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6,942 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 9 more variables: t_enters_next &lt;dttm&gt;, t_vacates &lt;dttm&gt;, t_red_off &lt;dttm&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   TSAR &lt;dbl&gt;, T_onset &lt;dbl&gt;, T_clear &lt;dbl&gt;, T_offset &lt;dbl&gt;, T_travel &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   T_coach &lt;dbl&gt;</span></span></span></code></pre></div>
<p>You can access these example data sets by running
<code>data(raw_centrix, asset_map)</code>. As you can see, the resulting
data frame contains the timings that we saw earlier:</p>
<ul>
<li>
<code>t_enters</code>: time the train enters the berth</li>
<li>
<code>t_red_on</code>: time the signal changes to red</li>
<li>
<code>t_enters_next</code>: time the train enters the next
berth</li>
<li>
<code>t_vacates</code>: time the train vacates the berth</li>
<li>
<code>t_red_off</code>: time the signal changes from red</li>
</ul>
<p>The <code>aspect</code> column gives the signal aspect that the train
saw as it entered the berth. In our previous example, the train saw a
green (<code>G</code>) aspect as it entered berth D.</p>
<p>The processed data frame contains calculated durations as well as
timings. These durations are derived from <code>TSAR</code>, which is
equal to <code>t_red_off - t_red_on</code>. <code>TSAR</code> stands for
‘Time Signal At Red’ and represents the amount of time (in seconds) that
the signal spent on a red aspect. The other durations calculated
are:</p>
<ul>
<li>
<code>T_onset</code>: <code>t_red_on - t_enters</code> time between
train entering berth and signal changing to red</li>
<li>
<code>T_clear</code>: <code>t_vacates - t_enters</code> time taken
for train to completely clear the berth</li>
<li>
<code>T_offset</code>: <code>t_red_off - t_vacates</code> time
between train vacating berth and signal changing from red</li>
<li>
<code>T_travel</code>: <code>t_enters_next - t_enters</code> time
taken for train to travel the length of the berth</li>
<li>
<code>T_coach</code>: <code>t_vacates - t_enters_next</code> time
taken for train to travel its own length</li>
</ul>
<p><code><a href="../reference/wrangle_centrix.html">wrangle_centrix()</a></code> also performs data validation,
potentially resulting in the loss of around 5% of data points. However,
this is necessary to ensure that the resulting journeys contain valid
data. As part of this, the function identifies individual train
journeys, labeling each train with a unique ID number.</p>
</div>
<div class="section level3">
<h3 id="clustering">Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h3>
<p>Centrix data contains no information about stopping patterns.
However, they can be deduced from travel times. As you can see from the
following plot, there are obvious differences in travel times in the
berths which contain stations.</p>
<p><img src="railvarr_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>These differences can be categorised using K-means clustering. This
is automated by the function <code><a href="../reference/cluster_journeys.html">cluster_journeys()</a></code>. This data
set contains 3 distinct groups of trains, which can be specified using
the <code>centers</code> parameter.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">berth_events_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cluster_journeys.html">cluster_journeys</a></span><span class="op">(</span><span class="va">berth_events</span>,</span>
<span>                                          centers <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>                                          iter.max <span class="op">=</span> <span class="fl">40L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_clusters.html">plot_clusters</a></span><span class="op">(</span><span class="va">berth_events_clusters</span><span class="op">)</span></span></code></pre></div>
<p><img src="railvarr_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Because K-means clustering is a stochastic algorithm, the results of
<code><a href="../reference/cluster_journeys.html">cluster_journeys()</a></code> are occasionally not what would be
expected. In that case, simply run the clustering again. Some trains may
also be miscategorised. This can be diagnosed visually using
<code><a href="../reference/plot_clusters.html">plot_clusters()</a></code>, but it is unfortunately a manual process
to remedy the issue.</p>
</div>
</div>
<div class="section level2">
<h2 id="timetable">Timetable<a class="anchor" aria-label="anchor" href="#timetable"></a>
</h2>
<p>Again, <code>railvarr</code> provides no functionality for reading
raw data. Therefore, the first step is to make sure your data lines up
with what <code>railvarr</code> expects. A timetable is a list of
events. Each event belongs to a train, denoted by its <a href="https://www.rail-record.co.uk/understanding-a-headcode/" class="external-link">headcode</a>
(<code>train_header</code>) and the time and date at which it originated
(<code>dt_origin</code>). An event also takes place at a geographical
location, commonly known as a <a href="http://www.railwaycodes.org.uk/crs/crs0.shtm" class="external-link">TIPLOC</a>. In
<code>railvarr</code> timetables, TIPLOCs live in the <code>geo</code>
column. We then also have the type of event, which is contained in the
<code>event</code> column. An event can have one of the following
types:</p>
<ul>
<li>
<code>Pass</code> train passes without stopping</li>
<li>
<code>Arrive</code> train arrives at a station</li>
<li>
<code>Depart</code> train departs a station</li>
<li>
<code>Originate</code> where the train originates from</li>
<li>
<code>Terminate</code> where the train will terminate</li>
</ul>
<p>Each event has a scheduled time (<code>wtt</code>) and an actual time
(<code>t</code>), as well as a delay (<code>delay</code>) which is
simply the difference between the actual and scheduled times. There is a
further column named <code>allow</code>, which is used for any
timetabled delay allowance. This is commonly used for ECS trains
(headcode starts with ‘5’) as they often incur delays waiting for
passenger services. The allowance means that delays can be expected and
aren’t necessarily problematic. For further information on the expected
structure of a raw timetable, see <code><a href="../reference/wrangle_timetable.html">wrangle_timetable()</a></code>.</p>
<p>Once your timetable is in the correct structure, you can go ahead and
use the <code><a href="../reference/wrangle_timetable.html">wrangle_timetable()</a></code> function. This function wraps
three processing functions:</p>
<ul>
<li><code><a href="../reference/filter_relevant_services.html">filter_relevant_services()</a></code></li>
<li><code><a href="../reference/filter_relevant_services.html">filter_relevant_direction()</a></code></li>
<li><code><a href="../reference/find_calling_patterns.html">find_calling_patterns()</a></code></li>
</ul>
<p>There are two extra parameters required for
<code><a href="../reference/wrangle_timetable.html">wrangle_timetable()</a></code>: <code>stations</code> and
<code>stopping_stations</code>.</p>
<p><code>stations</code> should be a list of TIPLOCs (<code>geo</code>)
through which trains pass. This list is used to work out which trains
travel through the track section of interest. For example, there could
be a fork in the track, where trains can travel to the left or to the
right. If you want to only look at trains which turn to the left,
<code>stations</code> would include all the TIPLOCs of interest which
are situated along the left track. Any trains which do not pass through
any of the TIPLOCs specified in <code>stations</code> will be
discarded.</p>
<p><code>stopping_stations</code> should be a subset of
<code>stations</code>, which specifies which TIPLOCs trains can stop at.
This is used for calculating calling patterns. Therefore, any train
which does not stop at any of the stations specified in
<code>stopping_stations</code> will be labeled as a ‘fast’ train. Trains
which do stop at these stations will be labeled with ‘stopping-’, with
the specific stations at which they stop attached as suffixes. For
example, if a train stops at ‘geo10’, its calling pattern will be
labeled as ‘stopping-geo10’.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example data from railvarr</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">timetable</span>, <span class="va">stations</span>, <span class="va">stopping_stations</span><span class="op">)</span></span>
<span><span class="co"># Raw timetable: note the number of observations and that none of the TIPLOCs </span></span>
<span><span class="co"># (`geo`) appear in the list of stations</span></span>
<span><span class="va">timetable</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8,958 × 11</span></span></span>
<span><span class="co">#&gt;    train_header dt_origin           geo    event     wtt                </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo1   Originate 2000-01-01 <span style="color: #949494;">12:20:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo18  Arrive    2000-01-01 <span style="color: #949494;">12:23:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo18  Depart    2000-01-01 <span style="color: #949494;">12:24:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo2   Arrive    2000-01-01 <span style="color: #949494;">12:28:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo2   Depart    2000-01-01 <span style="color: #949494;">12:29:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo3   Arrive    2000-01-01 <span style="color: #949494;">12:35:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo3   Depart    2000-01-01 <span style="color: #949494;">12:36:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo104 Arrive    2000-01-01 <span style="color: #949494;">12:39:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo104 Depart    2000-01-01 <span style="color: #949494;">12:39:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 168H         2000-01-01 <span style="color: #949494;">12:05:00</span> geo4   Arrive    2000-01-01 <span style="color: #949494;">12:41:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 8,948 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: t &lt;dttm&gt;, delay &lt;dbl&gt;, allow &lt;dbl&gt;, allow_perf &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   allow_path &lt;dbl&gt;, allow_eng &lt;dbl&gt;</span></span></span>
<span><span class="co"># List of TIPLOCs defining the track section of interest</span></span>
<span><span class="va">stations</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "geo5"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "geo6"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] "geo110"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; [1] "geo111"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; [1] "geo112"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[6]]</span></span>
<span><span class="co">#&gt; [1] "geo7" "geo8"</span></span>
<span><span class="co"># List of stations in the track section at which trains stop</span></span>
<span><span class="va">stopping_stations</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "geo110"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "geo111"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] "geo112"</span></span>
<span><span class="co"># Processed timetable: not how few observations persist, fewer than 10%; note </span></span>
<span><span class="co"># also that all the TIPLOCs apear in stations</span></span>
<span><span class="fu">railvarr</span><span class="fu">::</span><span class="fu"><a href="../reference/wrangle_timetable.html">wrangle_timetable</a></span><span class="op">(</span><span class="va">timetable</span>, <span class="va">stations</span>, <span class="va">stopping_stations</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 792 × 12</span></span></span>
<span><span class="co">#&gt;    train_header dt_origin           geo    event  wtt                </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo5   Arrive 2000-01-01 <span style="color: #949494;">13:34:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo5   Depart 2000-01-01 <span style="color: #949494;">13:35:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo6   Pass   2000-01-01 <span style="color: #949494;">13:37:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo110 Arrive 2000-01-01 <span style="color: #949494;">13:39:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo110 Depart 2000-01-01 <span style="color: #949494;">13:39:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo111 Arrive 2000-01-01 <span style="color: #949494;">13:42:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo111 Depart 2000-01-01 <span style="color: #949494;">13:42:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo112 Arrive 2000-01-01 <span style="color: #949494;">13:44:30</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo112 Depart 2000-01-01 <span style="color: #949494;">13:45:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 108H         2000-01-01 <span style="color: #949494;">12:55:00</span> geo7   Arrive 2000-01-01 <span style="color: #949494;">13:48:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 782 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7 more variables: t &lt;dttm&gt;, delay &lt;dbl&gt;, allow &lt;dbl&gt;, allow_perf &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   allow_path &lt;dbl&gt;, allow_eng &lt;dbl&gt;, group &lt;chr&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="id-matching">ID Matching<a class="anchor" aria-label="anchor" href="#id-matching"></a>
</h2>
<p>Clustering is a pre-requisite of the ID matching algorithm, which
matches Centrix data with timetabling information. Timetabling data is
necessary for calculating delay, and is useful in the analysis of dwell
times. It is highly recommended that you manually label the clusters
found by <code><a href="../reference/cluster_journeys.html">cluster_journeys()</a></code> to match the calling patterns
in the timetable.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Sebastian Merricks.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
