---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# railvarr

<!-- badges: start -->
[![R-CMD-check](https://github.com/sebmerricks/railvarr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/sebmerricks/railvarr/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of `railvarr` is to ...

## Installation

You can install the development version of railvarr from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("sebmerricks/railvarr")
```

## Pipeline

`railvarr` implements 5 key processing steps for the analysis of Centrix data.

### 1. Centrix Processing

In this step, the raw Centrix data are converted into human-readable berth-level
observations. This step also removes anomalies and invalid data. Up to around 5%
of the data can be lost. There are three inputs for this step:

#### 1. Raw Centrix data

Centrix observations consist of four data points:

 * `asset` a character string containing the asset ID
 * `state` a character string representing the state of the asset
 * `dt` the date and time at which the event took place
 * `transition` the state transition that caused the event

For example, a train entering track `'TA-1'` on the 2nd January 2020 at 17:03 
would produce the following Centrix observation:

```{r echo = FALSE}
dplyr::tribble(
  ~asset, ~state, ~dt, ~transition,
  "TA-1", "TR", lubridate::as_datetime("2020-01-02 17:03:00"), "UP to DN"
)
```

The state `'TR'` is simply a placeholder, because this observation relates to a
track asset. The state component is only relevant for signal events, in which 
case it represents the signal aspect. The transition `'UP to DN'` represents a
train entering the track, while a transition of `'DN to UP'` would represent a 
train exiting the track.

#### 2. Asset mapping

The asset mapping is a representation of the track section. Currently, the track
is represented by a linear data frame. However, this does not support more 
complex track layouts like junctions. The asset map should contain a 1-1 mapping
from signal ID to berth name, a 1-many mapping from berth name to track ID, and
an extra `event` column. For example, a simple track section with two berths, 
two signals, and three tracks would be:

```{r echo = FALSE}
dplyr::tribble(
  ~signal, ~berth, ~track, ~event,
  "S1", "A", "TA-1", "enters",
  "S1", "A", "TA-1", "vacates",
  "S1", "A", "TA-2", "enters",
  "S1", "A", "TA-2", "vacates",
  "S2", "B", "TB", "enters",
  "S2", "B", "TB", "vacates"
)
```

The `event` column represents the fact that there are separate Centrix 
observations for trains entering and exiting a track. Therefore, each track can
have both an `'enters'` and `'vacates'` event associated with it. In order to
calculate berth travel times, it is necessary to know when a train entered the
following berth. However, if we used the asset map given above, we would not 
include data for the `'enters'` event at signal `'S3'`. Therefore, we would not
be able to calculate travel times for `'S2'`. If these travel time calculations
are important, it is recommended to include the extra event in the asset map:

```{r echo = FALSE}
dplyr::tribble(
  ~signal, ~berth, ~track, ~event,
  "S3", "C", "TC", "enters"
)
```

#### 3. State mapping

The state mapping provides a 1-1 mapping from signal state codes to signal 
aspects. This is standardised, so `railvarr` provides a default mapping that you
can access by running

```{r}
data(state_mapping)
state_mapping
```

See [this website](https://wiki.openraildata.com/index.php/Signalling_Nomenclature#Signals)
for other codes.

### 2. Centrix Clustering

### 3. Timetable Processing

### 4. ID Matching

### 5. Dwell Time and Delays

![Diagram of the processing pipeline that `railvarr` provides](man/figures/README-pipeline.PNG)

## Getting Started

The first step is to massage your raw data into the correct structure, as `railvarr` provides no reading functionality.

### Centrix

A detailed overview of what is expected for Centrix data can be found in [wrangle_centrix()](https://sebmerricks.github.io/railvarr/reference/wrangle_centrix.html). Here is an example of a valid Centrix data frame:
```{r raw_centrix}
data(raw_centrix)
head(raw_centrix, 10)
```

## Timetable

A detailed overview of what is expected for Timetable data can be found in [wrangle_timetable()](https://sebmerricks.github.io/railvarr/reference/wrangle_timetable.html). Here is an example of a valid Timetable data frame:
```{r raw_timetable}
data(timetable)
head(timetable, 10)
```
